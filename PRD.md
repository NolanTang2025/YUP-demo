# YUP信用卡用户意图聚类分析系统 - 产品需求文档（PRD）

## 1. 项目概述

### 1.1 项目背景
YUP信用卡公司需要深入理解客户在获得信用额度后的首次交易行为模式，以识别不同用户的意图类型，从而优化产品体验、提升转化率，并为不同用户群体提供个性化的服务和营销策略。

### 1.2 项目目标
- **核心目标**：通过机器学习聚类算法，自动识别和分类用户在获得信用额度后的行为意图模式
- **业务目标**：
  - 区分完成交易用户和未完成交易用户的行为特征
  - 识别不同用户群体的行为模式差异
  - 为产品优化和精准营销提供数据支持
  - 提升用户转化率和用户体验

### 1.3 目标用户
- **主要用户**：YUP信用卡产品团队、数据分析团队、运营团队
- **使用场景**：
  - 定期分析用户行为数据，识别用户意图模式
  - 评估产品功能效果和用户转化情况
  - 制定针对不同用户群体的运营策略

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 数据导入与处理
- **功能描述**：支持从CSV文件导入用户行为数据
- **输入要求**：
  - 文件格式：CSV
  - 必需字段：
    - `user_uuid`: 用户唯一标识
    - `event_time`: 事件发生时间
    - `event_name`: 事件名称
  - 可选字段：
    - `approved_time`: 账户批准时间
    - `fir_trx_time` / `first_payment_time`: 首次交易时间
    - `remarks` / `extra_info`: 备注信息（营销活动等）
- **处理能力**：
  - 自动检测文件编码（支持UTF-8、GBK、GB2312、Latin-1）
  - 自动处理时间字段格式转换
  - 过滤无效数据（如user_uuid为空的记录）

#### 2.1.2 用户行为向量化（Embedding）
- **功能描述**：使用Google Gemini Embedding模型将用户行为序列转换为高维向量
- **技术实现**：
  - 使用Google Gemini API的`embedding-001`模型
  - 将用户行为序列转换为自然语言描述
  - 生成768维向量表示（具体维度取决于Gemini模型）
- **行为文本生成规则**：
  - 账户批准时间信息（工作日、时间段）
  - 批准到首次行为的时间间隔
  - 用户行为事件序列（简化事件名称）
  - 营销活动信息（如有）
  - 会话摘要统计（事件数、时长）
  - 交易完成状态
- **性能优化**：
  - 支持缓存机制，避免重复调用API
  - 支持增量更新，仅处理新用户
  - 实现重试机制和速率限制，处理API错误

#### 2.1.3 聚类分析
- **功能描述**：使用K-means算法对用户向量进行聚类分析
- **聚类策略**：
  - 自动确定最优聚类数量（使用轮廓系数评估，范围2-10）
  - 支持手动指定聚类数量
  - 对主聚类进行子聚类分析（细化用户群体）
- **聚类命名**：
  - 基于交易完成率自动生成聚类标签：
    - 完成率 > 70%: "High Conversion Intent"（高转化意图）
    - 完成率 30%-70%: "Medium Conversion Intent"（中等转化意图）
    - 完成率 < 30%: "Exploration Intent"（探索意图）
- **输出结果**：
  - 每个用户的聚类标签和子聚类标签
  - 聚类统计信息（用户数、占比、完成率等）

#### 2.1.4 可视化报告生成
- **功能描述**：生成交互式HTML分析报告
- **报告内容**：
  1. **总体概览**
     - 用户总数、聚类数量
     - 聚类分布统计
     - 交易完成率对比
  2. **聚类分析可视化**
     - PCA降维散点图（2D/3D）
     - 聚类中心距离热力图
     - 聚类特征对比雷达图
  3. **用户行为分析**
     - 事件类型分布
     - 行为序列模式
     - 时间分布分析
  4. **用户列表**
     - 可搜索、可筛选的用户列表
     - 分页显示
     - 支持按聚类、交易状态等筛选
  5. **用户路径可视化**
     - 为每个用户生成独立的路径HTML文件
     - 展示用户完整的行为序列
     - 标注关键节点（批准时间、首次交易等）

#### 2.1.5 缓存管理
- **功能描述**：缓存embedding结果，提高分析效率
- **缓存策略**：
  - 基于数据文件哈希值验证缓存有效性
  - 用户级别的embedding缓存
  - 自动检测数据变更，失效旧缓存
- **缓存位置**：`cache/`目录
- **缓存文件**：
  - `user_embeddings_cache.pkl`: 用户级别embedding缓存
  - `embeddings_{hash}.pkl`: 完整embedding数据缓存

### 2.2 辅助功能

#### 2.2.1 错误处理
- API调用失败重试机制（最多3次，指数退避）
- 数据验证和错误提示
- 部分用户失败时的容错处理

#### 2.2.2 进度提示
- 显示embedding提取进度
- 显示聚类分析进度
- 显示报告生成进度

## 3. 非功能需求

### 3.1 性能要求
- **数据处理能力**：支持处理数千到数万用户的数据
- **API调用优化**：
  - 请求间隔：0.2-0.5秒（随机延迟，避免速率限制）
  - 支持批量处理，显示进度
- **缓存效率**：使用缓存后，重复分析时间减少90%以上

### 3.2 可靠性要求
- **API容错**：自动重试机制，处理临时性API错误
- **数据完整性**：确保所有有效用户都被处理
- **缓存一致性**：自动检测数据变更，确保缓存有效性

### 3.3 易用性要求
- **配置简单**：仅需设置API密钥和环境变量
- **输出清晰**：生成易于理解的HTML报告
- **错误提示**：提供清晰的错误信息和解决建议

### 3.4 可维护性要求
- **代码结构**：面向对象设计，功能模块化
- **扩展性**：易于添加新的特征提取或聚类算法
- **文档完善**：代码注释清晰，README文档完整

## 4. 技术架构

### 4.1 技术栈
- **编程语言**：Python 3.x
- **核心库**：
  - `pandas`, `numpy`: 数据处理
  - `google-generativeai`: Google Gemini API调用
  - `scikit-learn`: 机器学习（K-means, PCA, StandardScaler）
  - `plotly`: 交互式可视化
- **数据存储**：
  - 输入：CSV文件
  - 缓存：Pickle文件
  - 输出：HTML文件

### 4.2 系统架构
```
用户行为数据 (CSV)
    ↓
数据加载与预处理
    ↓
用户行为文本生成
    ↓
Gemini Embedding API
    ↓
向量化结果 (缓存)
    ↓
特征标准化
    ↓
K-means 聚类
    ↓
聚类结果分析
    ↓
HTML报告生成
```

### 4.3 关键算法
- **Embedding模型**：Google Gemini `embedding-001`
- **聚类算法**：K-means（scikit-learn）
- **降维算法**：PCA（用于可视化）
- **评估指标**：轮廓系数（Silhouette Score）

## 5. 数据需求

### 5.1 输入数据格式
- **文件格式**：CSV
- **必需字段**：
  - `user_uuid` (string): 用户唯一标识
  - `event_time` (datetime): 事件时间
  - `event_name` (string): 事件名称
- **可选字段**：
  - `approved_time` (datetime): 账户批准时间
  - `fir_trx_time` / `first_payment_time` (datetime): 首次交易时间
  - `remarks` / `extra_info` (string): 备注信息

### 5.2 数据质量要求
- 用户UUID不能为空
- 事件时间格式正确
- 建议数据量：至少100个用户，以获得有意义的聚类结果

### 5.3 输出数据格式
- **主报告**：`index.html` - 完整的聚类分析报告
- **用户路径**：`user_path_{user_uuid}.html` - 每个用户的详细路径
- **缓存文件**：`cache/*.pkl` - embedding和聚类结果缓存

## 6. 接口与配置

### 6.1 API配置
- **Google Gemini API Key**：
  - 通过环境变量 `GEMINI_API_KEY` 设置
  - 或通过代码参数传入
- **API限制**：需要遵守Google Gemini API的速率限制和配额

### 6.2 运行配置
- **数据文件路径**：默认 `data.csv`，可通过代码修改
- **缓存目录**：`cache/`（自动创建）
- **输出目录**：当前目录

## 7. 使用流程

### 7.1 准备工作
1. 安装依赖：`pip install pandas numpy scikit-learn plotly google-generativeai`
2. 设置API密钥：`export GEMINI_API_KEY='your-api-key'`
3. 准备数据文件：确保CSV文件格式正确

### 7.2 执行分析
1. 运行脚本：`python user_intent_clustering.py`
2. 系统自动执行：
   - 加载数据
   - 提取embedding（使用缓存或调用API）
   - 执行聚类分析
   - 生成HTML报告

### 7.3 查看结果
1. 打开 `index.html` 查看主报告
2. 点击用户列表中的用户，查看详细路径
3. 根据聚类结果制定运营策略

## 8. 业务价值

### 8.1 直接价值
- **用户分群**：自动识别不同意图的用户群体
- **转化优化**：识别高转化和低转化用户特征，优化产品流程
- **精准运营**：为不同用户群体制定差异化策略

### 8.2 间接价值
- **数据驱动决策**：基于数据洞察而非经验判断
- **效率提升**：自动化分析流程，减少人工分析时间
- **持续优化**：可定期运行，跟踪用户行为变化趋势

## 9. 未来扩展

### 9.1 功能扩展
- 支持更多聚类算法（DBSCAN、层次聚类等）
- 支持实时分析（流式数据处理）
- 支持多维度分析（时间序列、地理位置等）
- 集成预测模型（预测用户转化概率）

### 9.2 性能优化
- 支持分布式处理（大规模用户数据）
- 优化API调用策略（批量请求）
- 支持增量更新（仅分析新用户）

### 9.3 用户体验
- Web界面（替代命令行）
- 交互式报告（实时筛选、钻取）
- 导出功能（PDF、Excel等格式）

## 10. 风险评估

### 10.1 技术风险
- **API依赖**：依赖Google Gemini API，存在服务中断风险
  - 缓解措施：实现重试机制和错误处理
- **API配额**：可能遇到API调用限制
  - 缓解措施：实现缓存机制，减少重复调用

### 10.2 数据风险
- **数据质量**：输入数据质量影响分析结果
  - 缓解措施：实现数据验证和清洗
- **数据隐私**：用户行为数据涉及隐私
  - 缓解措施：遵循数据保护规范，本地处理

### 10.3 业务风险
- **聚类效果**：聚类结果可能不符合业务预期
  - 缓解措施：支持手动调整聚类数量，提供多种评估指标

## 11. 成功指标

### 11.1 技术指标
- 系统正常运行率 > 95%
- API调用成功率 > 98%（含重试）
- 报告生成成功率 100%

### 11.2 业务指标
- 聚类结果可解释性（业务团队认可度）
- 分析效率提升（相比人工分析）
- 基于聚类结果的运营策略效果

## 12. 附录

### 12.1 术语表
- **Embedding**：将文本或行为序列转换为数值向量的过程
- **K-means**：一种基于距离的聚类算法
- **轮廓系数**：评估聚类质量的指标，范围-1到1，越高越好
- **PCA**：主成分分析，用于降维和可视化

### 12.2 参考资料
- Google Gemini API文档
- scikit-learn文档
- Plotly可视化文档

---

**文档版本**：1.0  
**最后更新**：2025-01-XX  
**维护者**：YUP数据分析团队
